<input ref:input type="date" class="{class}" />

<script>
import flatpickr from 'flatpickr';

const hooks = new Set([
	'onChange',
	'onOpen',
	'onClose',
	'onMonthChange',
	'onYearChange',
	'onReady',
	'onValueUpdate',
	'onDayCreate'
]);

export default {
	data() {
		return {
			value: null,
			class: null,
			options: {}
		};
	},

	oncreate() {
		this.updateValue = value => {
			if (Array.isArray(value) && value.length === 1)
				value = value[0];

			this.set({value});
		};

		this.fp = flatpickr(this.refs.input, this.addHooks(this.get('options')));

		this.observe('options', options => {
			options = this.addHooks(options);

			for (let [key, val] in Object.entries(options)) {
				this.fp.set(key, val);
			}
		});

		this.observe('value', (value, oldValue) => {
			if (value !== oldValue)
				this.fp.setDate(value);
		});
	},

	methods: {
		addHooks(options) {
			options = Object.assign({}, options);

			for (let hook of hooks) {
				let firer = (selectedDates, dateStr, instance) => {
					this.fire(stripOn(hook), [selectedDates, dateStr, instance]);
				};

				if (hook in options) {
					// Hooks must be arrays
					if (!Array.isArray(options[hook]))
						options[hook] = [options[hook]];

					options[hook].push(firer);
				} else {
					options[hook] = [firer];
				}
			}

			if (options.onChange && !options.onChange.includes(this.updateValue))
				options.onChange.push(this.updateValue);

			return options;
		}
	},

	ondestroy() {
		if (this.fp && 'destroy' in this.fp)
			this.fp.destroy();
	}
};

function stripOn(hook) {
	return hook.charAt(2).toLowerCase() + hook.substring(3);
};
</script>
